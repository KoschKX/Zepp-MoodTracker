<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Mood Tracker Settings Test</title>
    <style>
        body { margin: 0; padding: 20px; background: #000; color: #fff; font-family: sans-serif; }
        #status { background: #222; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
        #frame-container { width: 100%; height: 800px; }
        iframe { width: 100%; height: 100%; border: 2px solid #333; border-radius: 8px; }
    </style>
</head>
<body>
    <div id="status">
        <h2>Mood Tracker Settings - Test Page</h2>
        <p>Testing settings page with mock storage...</p>
        <button onclick="setTestData()">Write Test Data to Storage</button>
        <button onclick="clearStorage()">Clear Storage</button>
        <button onclick="reloadSettings()">Reload Settings Page</button>
        <pre id="storage-display"></pre>
    </div>
    
    <div id="frame-container">
        <iframe id="settings-frame" src=""></iframe>
    </div>

    <script>
        // Mock settingsStorage for testing
        const mockStorage = {};
        
        // Seed some test data
        mockStorage['appSideInitRan'] = new Date().toISOString();
        mockStorage['appSideStatus'] = 'initialized';
        mockStorage['moodData'] = JSON.stringify({
            '2026-02-01': 5,
            '2026-02-02': 4,
            '2026-02-03': 3,
            '2026-02-04': 4,
            '2026-02-05': 5
        });

        function updateDisplay() {
            document.getElementById('storage-display').textContent = 
                'Storage Contents:\n' + JSON.stringify(mockStorage, null, 2);
        }

        function setTestData() {
            mockStorage['moodData'] = JSON.stringify({
                '2026-02-01': 5,
                '2026-02-02': 4,
                '2026-02-03': 3,
                '2026-02-04': 2,
                '2026-02-05': 1,
                '2026-02-06': 3,
                '2026-02-07': 4,
                '2026-02-08': 5
            });
            mockStorage['lastSync'] = new Date().toISOString();
            mockStorage['appSideInitRan'] = new Date().toISOString();
            updateDisplay();
            reloadSettings();
        }

        function clearStorage() {
            Object.keys(mockStorage).forEach(key => delete mockStorage[key]);
            updateDisplay();
            reloadSettings();
        }

        function reloadSettings() {
            const frame = document.getElementById('settings-frame');
            frame.src = frame.src || './setting/index.js?' + Date.now();
        }

        // Inject mock into the iframe when it loads
        function injectMockStorage() {
            const frame = document.getElementById('settings-frame');
            try {
                const frameWindow = frame.contentWindow;
                
                // Create mock settingsStorage object
                const mockSettingsStorage = {
                    getItem: (key) => {
                        console.log('getItem:', key, mockStorage[key]);
                        return mockStorage[key] || null;
                    },
                    setItem: (key, value) => {
                        console.log('setItem:', key, value);
                        mockStorage[key] = value;
                        updateDisplay();
                    },
                    removeItem: (key) => {
                        console.log('removeItem:', key);
                        delete mockStorage[key];
                        updateDisplay();
                    }
                };

                // Try to inject into the frame context
                frameWindow.mockProps = {
                    settingsStorage: mockSettingsStorage
                };

                console.log('Mock storage injected successfully');
            } catch (e) {
                console.error('Failed to inject mock storage:', e);
            }
        }

        updateDisplay();
        
        // Load the settings page (you'll need to point at the built file)
        window.addEventListener('load', () => {
            alert('Please build the project first with: zeus build\nThen update the iframe src to point to: dist/416x416-amazfit-gtr-mini/setting/index.html');
        });
    </script>
</body>
</html>
